---
const { soundUrls = [], cursors = [] } = Astro.props;
---

<div class="fixed top-0 right-0 p-4 text-xs md:text-sm z-20 select-none">
    <input type="radio" id="sound-toggle"></input>
    <label for="sound-toggle">CLICK ;)</label>
</div>

<!-- Cursor follower -->
<div id="cursor-follower" class="fixed pointer-events-none mix-blend-multiply z-50 opacity-0 transition-opacity duration-200">
    <img id="cursor-image" src="" alt="" class="w-8 h-8 object-contain">
</div>

<script define:vars={{ soundUrls, cursors }}>
    let audioElements = [];
    let currentlyPlaying = null;
    let soundEnabled = false;
    let currentSoundIndex = -1;
    let currentCursorIndex = -1;
    let cursorFollower = null;
    let cursorImage = null;
    let isFollowing = true;

    function shuffle(theArray) {
        var tmp;
        for (var i = 0; i < theArray.length; i++) {
            // Generate random index into the array:
            var j = Math.floor(Math.random() * theArray.length);

            // Swap current item with random item:
            tmp = theArray[i];
            theArray[j] = theArray[i];
            theArray[i] = tmp;
        }
        return theArray;
    }

    function updateCursorPosition(e) {
        if (cursorFollower && isFollowing) {
            cursorFollower.style.left = e.clientX+ 20 + 'px';
            cursorFollower.style.top = e.clientY + 20 + 'px';
            cursorFollower.style.transform = 'translate(-50%, -50%)';
        }
    }

    function showCursor() {
        if (!cursors || cursors.length === 0) return;

        currentCursorIndex = (currentCursorIndex + 1) % cursors.length;

        const cursor = cursors[currentCursorIndex];
        
        if (cursorImage && cursorFollower) {
            cursorImage.src = cursor.source_url;
            cursorFollower.classList.remove('opacity-0');
            cursorFollower.classList.add('opacity-100');
        }
    }

    function hideCursor() {
        if (cursorFollower) {
            cursorFollower.classList.remove('opacity-100');
            cursorFollower.classList.add('opacity-0');
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Get cursor elements
        cursorFollower = document.getElementById('cursor-follower');
        cursorImage = document.getElementById('cursor-image');

        // Create audio elements from the server-side soundUrls
        shuffle(soundUrls);
        shuffle(cursors);
        if (soundUrls && soundUrls.length > 0) {
            audioElements = soundUrls.map((url) => {
                const audio = new Audio(url);
                audio.volume = 0.7;
                return audio;
            });
        }

        const soundToggle = document.getElementById("sound-toggle");

        soundToggle?.addEventListener("click", (e) => {
            e.stopPropagation();
            soundEnabled = !soundEnabled;
            document.querySelector('#sound-toggle ~ label').textContent = soundEnabled ? "CLICK ;(" : "CLICK ;)";
            soundToggle.checked = soundEnabled;
        });

        // Add mouse move listener
        document.addEventListener('mousemove', updateCursorPosition);

        document.addEventListener("click", (e) => {
            if (!soundEnabled || audioElements.length === 0) return;
            // Ignore clicks on links or buttons
            if (
                e.target.tagName === "A" ||
                e.target.tagName === "BUTTON" ||
                e.target.closest("a") ||
                e.target.closest("button")
            ) {
                return;
            }

            playSound();
            showCursor();
        });
    });

    function playSound() {
        if (audioElements.length === 0) return;
        currentSoundIndex = (currentSoundIndex + 1) % audioElements.length;

        // Stop currently playing sound
        if (currentlyPlaying) {
            currentlyPlaying.pause();
            currentlyPlaying.currentTime = 0;
        }

        // Pick random sound
        const selectedAudio = audioElements[currentSoundIndex];

        // Play the sound
        selectedAudio.play().catch((error) => {
            console.log("Audio play failed:", error);
        });

        currentlyPlaying = selectedAudio;

        // Reset when sound ends
        selectedAudio.addEventListener("ended", () => {
            currentlyPlaying = null;
            hideCursor();
        });
    }
</script>
